# ============================================================================
# GitLab CI/CD Pipeline for React TypeScript Application
# ============================================================================
# 
# Pipeline Structure:
# 1. PR Pipeline: Runs on every PR and commit push (automatic)
#    - Validation, Testing, Security, Build
# 2. Merge Pipeline: Runs on merge to main (automatic + manual deploy)
#    - All PR checks + Staging deployment (auto) + Production (manual)
#
# ============================================================================

variables:
  # Node.js Configuration
  NODE_VERSION: "20"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"
  
  # Application Configuration
  APP_NAME: "usermn1"
  REACT_VERSION: "19"
  
  # Build Configuration
  NODE_ENV: "production"
  CI: "true"
  
  # Quality Thresholds
  COVERAGE_THRESHOLD: "80"
  PERFORMANCE_SCORE_MIN: "90"
  
  # AWS Configuration (set these in GitLab CI/CD Variables)
  # AWS_ACCESS_KEY_ID: (secret)
  # AWS_SECRET_ACCESS_KEY: (secret)
  # AWS_DEFAULT_REGION: (e.g., us-east-1)
  # S3_BUCKET_STAGING: (e.g., usermn1-staging)
  # S3_BUCKET_PRODUCTION: (e.g., usermn1-production)
  # CLOUDFRONT_DISTRIBUTION_ID_STAGING: (optional)
  # CLOUDFRONT_DISTRIBUTION_ID_PRODUCTION: (optional)

# ============================================================================
# Pipeline Stages
# ============================================================================
stages:
  - install        # Install dependencies (caching)
  - validate       # Code quality checks
  - test           # Run all tests
  - security       # Security scans
  - build          # Build application
  - deploy-staging # Auto deploy to staging (on merge only)
  - deploy-prod    # Manual deploy to production (on merge only)


# ============================================================================
# Cache Configuration
# ============================================================================
.cache_dependencies:
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm
      - node_modules
    policy: pull-push

.cache_pull_only:
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm
      - node_modules
    policy: pull

# ============================================================================
# Job Templates
# ============================================================================
.node_base:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - echo "üîß Node $(node --version) | NPM $(npm --version)"
    - echo "üì¶ Installing dependencies..."
    - npm ci --cache .npm --prefer-offline

# Template for PR jobs (runs on every PR and commit push to PR)
.pr_pipeline:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: never

# Template for main branch jobs (runs on merge to main)
.main_branch:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always

# ============================================================================
# STAGE 1: INSTALL DEPENDENCIES
# ============================================================================
install:
  stage: install
  extends: 
    - .node_base
    - .cache_dependencies
  script:
    - echo "‚úÖ Dependencies installed and cached"
  artifacts:
    paths:
      - node_modules
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

# ============================================================================
# STAGE 2: VALIDATION (Runs on every PR and commit)
# ============================================================================

typecheck:
  stage: validate
  extends:
    - .node_base
    - .cache_pull_only
  script:
    - echo "üîç Running TypeScript type checking..."
    - npm run type-check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

lint:
  stage: validate
  extends:
    - .node_base
    - .cache_pull_only
  script:
    - echo "üîç Running ESLint..."
    - npm run lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

format_check:
  stage: validate
  extends:
    - .node_base
    - .cache_pull_only
  script:
    - echo "üîç Checking code formatting..."
    - npm run format:check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================================================
# STAGE 3: TESTING (Runs on every PR and commit)
# ============================================================================

unit_tests:
  stage: test
  extends:
    - .node_base
    - .cache_pull_only
  script:
    - echo "üß™ Running unit tests..."
    - npm run test:unit
    - echo "üìä Generating coverage report..."
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      junit: reports/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

e2e_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "üé≠ Running E2E tests..."
    - npm run test:e2e || echo "‚ö†Ô∏è  E2E tests not fully configured"
  artifacts:
    when: always
    paths:
      - playwright-report
      - test-results
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# ============================================================================
# STAGE 4: SECURITY (Runs on every PR and commit)
# ============================================================================

security_audit:
  stage: security
  extends:
    - .node_base
    - .cache_pull_only
  script:
    - echo "üîí Running NPM security audit..."
    - npm audit --audit-level=moderate || echo "‚ö†Ô∏è  Security vulnerabilities found"
    - npm run security:audit || echo "‚ö†Ô∏è  Security audit completed with warnings"
  artifacts:
    paths:
      - npm-audit.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# ============================================================================
# STAGE 5: BUILD (Runs on every PR and commit)
# ============================================================================

build_pr:
  stage: build
  extends:
    - .node_base
    - .cache_pull_only
  script:
    - echo "üèóÔ∏è  Building application for PR validation..."
    - npm run build
    - echo "üì¶ Build completed"
    - ls -lah dist/
    - du -sh dist/
  artifacts:
    paths:
      - dist
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

build_production:
  stage: build
  extends:
    - .node_base
    - .cache_pull_only
  script:
    - echo "üèóÔ∏è  Building application for production..."
    - npm run build:prod
    - echo "üì¶ Production build completed"
    - ls -lah dist/
    - du -sh dist/
    - echo "üîê Generating checksums..."
    - find dist -type f -exec sha256sum {} \; > dist/checksums.txt
  artifacts:
    paths:
      - dist
    expire_in: 4 weeks
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================================================
# STAGE 6: DEPLOY TO STAGING (Automatic on merge to main)
# ============================================================================

deploy_staging:
  stage: deploy-staging
  image: amazon/aws-cli:latest
  needs: ["build_production"]
  before_script:
    - echo "üöÄ Preparing staging deployment..."
    - aws --version
  script:
    - echo "üì§ Deploying to staging environment..."
    - |
      if [ -z "$S3_BUCKET_STAGING" ]; then
        echo "‚ö†Ô∏è  S3_BUCKET_STAGING not configured in CI/CD variables"
        echo "Please set AWS credentials and S3 bucket in GitLab CI/CD settings"
        exit 1
      fi
    
    - echo "Uploading static assets to S3: $S3_BUCKET_STAGING"
    - |
      aws s3 sync dist/ s3://$S3_BUCKET_STAGING/ \
        --delete \
        --cache-control "public, max-age=31536000, immutable" \
        --exclude "index.html" \
        --exclude "*.html" \
        --exclude "manifest.webmanifest"
    
    - echo "Uploading HTML files with no-cache policy..."
    - |
      aws s3 sync dist/ s3://$S3_BUCKET_STAGING/ \
        --cache-control "public, max-age=0, must-revalidate" \
        --exclude "*" \
        --include "*.html" \
        --include "manifest.webmanifest"
    
    - |
      if [ -n "$CLOUDFRONT_DISTRIBUTION_ID_STAGING" ]; then
        echo "üîÑ Invalidating CloudFront cache..."
        INVALIDATION_ID=$(aws cloudfront create-invalidation \
          --distribution-id $CLOUDFRONT_DISTRIBUTION_ID_STAGING \
          --paths "/*" \
          --query 'Invalidation.Id' \
          --output text)
        echo "Invalidation ID: $INVALIDATION_ID"
      else
        echo "‚ö†Ô∏è  CloudFront distribution ID not set, skipping cache invalidation"
      fi
    
    - echo "‚úÖ Staging deployment completed!"
    - echo "üåê Staging URL: https://$S3_BUCKET_STAGING/"
  environment:
    name: staging
    url: https://$S3_BUCKET_STAGING
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
  allow_failure: false

# ============================================================================
# STAGE 7: DEPLOY TO PRODUCTION (MANUAL - on merge to main)
# ============================================================================

deploy_production:
  stage: deploy-prod
  image: amazon/aws-cli:latest
  needs: ["deploy_staging"]
  before_script:
    - echo "üöÄ Preparing PRODUCTION deployment..."
    - aws --version
  script:
    - echo "‚ö†Ô∏è  DEPLOYING TO PRODUCTION ENVIRONMENT"
    - |
      if [ -z "$S3_BUCKET_PRODUCTION" ]; then
        echo "‚ùå S3_BUCKET_PRODUCTION not configured in CI/CD variables"
        exit 1
      fi
    
    - echo "üì¶ Creating backup of current production..."
    - |
      BACKUP_BUCKET="${S3_BUCKET_PRODUCTION}-backup-$(date +%Y%m%d-%H%M%S)"
      aws s3 sync s3://$S3_BUCKET_PRODUCTION/ s3://$BACKUP_BUCKET/ || echo "No existing deployment to backup"
      echo "Backup created: $BACKUP_BUCKET"
    
    - echo "üì§ Uploading static assets to production..."
    - |
      aws s3 sync dist/ s3://$S3_BUCKET_PRODUCTION/ \
        --delete \
        --cache-control "public, max-age=31536000, immutable" \
        --exclude "index.html" \
        --exclude "*.html" \
        --exclude "manifest.webmanifest"
    
    - echo "üì§ Uploading HTML files..."
    - |
      aws s3 sync dist/ s3://$S3_BUCKET_PRODUCTION/ \
        --cache-control "public, max-age=0, must-revalidate" \
        --exclude "*" \
        --include "*.html" \
        --include "manifest.webmanifest"
    
    - |
      if [ -n "$CLOUDFRONT_DISTRIBUTION_ID_PRODUCTION" ]; then
        echo "üîÑ Invalidating CloudFront cache..."
        INVALIDATION_ID=$(aws cloudfront create-invalidation \
          --distribution-id $CLOUDFRONT_DISTRIBUTION_ID_PRODUCTION \
          --paths "/*" \
          --query 'Invalidation.Id' \
          --output text)
        
        echo "Invalidation ID: $INVALIDATION_ID"
        echo "‚è≥ Waiting for invalidation to complete..."
        aws cloudfront wait invalidation-completed \
          --distribution-id $CLOUDFRONT_DISTRIBUTION_ID_PRODUCTION \
          --id $INVALIDATION_ID || echo "Invalidation in progress..."
      fi
    
    - echo "‚úÖ PRODUCTION DEPLOYMENT COMPLETED SUCCESSFULLY!"
    - echo "üåê Production URL: https://$S3_BUCKET_PRODUCTION/"
  environment:
    name: production
    url: https://$S3_BUCKET_PRODUCTION
    on_stop: rollback_production
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: false

# ============================================================================
# ROLLBACK PRODUCTION (MANUAL - emergency use only)
# ============================================================================

rollback_production:
  stage: deploy-prod
  image: amazon/aws-cli:latest
  script:
    - echo "üîÑ ROLLING BACK PRODUCTION DEPLOYMENT..."
    - |
      if [ -z "$S3_BUCKET_PRODUCTION" ]; then
        echo "‚ùå S3_BUCKET_PRODUCTION not configured"
        exit 1
      fi
    
    - echo "üîç Finding latest backup..."
    - |
      LATEST_BACKUP=$(aws s3 ls | grep "${S3_BUCKET_PRODUCTION}-backup-" | tail -1 | awk '{print $3}')
      
      if [ -z "$LATEST_BACKUP" ]; then
        echo "‚ùå No backup found for rollback"
        exit 1
      fi
      
      echo "üì¶ Restoring from backup: $LATEST_BACKUP"
      aws s3 sync s3://$LATEST_BACKUP/ s3://$S3_BUCKET_PRODUCTION/ --delete
    
    - |
      if [ -n "$CLOUDFRONT_DISTRIBUTION_ID_PRODUCTION" ]; then
        echo "üîÑ Invalidating CloudFront cache after rollback..."
        aws cloudfront create-invalidation \
          --distribution-id $CLOUDFRONT_DISTRIBUTION_ID_PRODUCTION \
          --paths "/*"
      fi
    
    - echo "‚úÖ Rollback completed successfully!"
  environment:
    name: production
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: false

# ============================================================================
# POST-DEPLOYMENT NOTIFICATIONS
# ============================================================================

notify_deployment:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "üì¢ Generating deployment summary..."
    - |
      cat <<EOF
      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      üéâ DEPLOYMENT SUMMARY
      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      
      üì¶ Application: $APP_NAME
      üåø Branch: $CI_COMMIT_BRANCH
      üìù Commit: $CI_COMMIT_SHORT_SHA
      üë§ Author: $CI_COMMIT_AUTHOR
      üè∑Ô∏è  Message: $CI_COMMIT_TITLE
      
      üîó Pipeline: $CI_PIPELINE_URL
      ‚è±Ô∏è  Duration: $CI_PIPELINE_DURATION seconds
      
      üåê Staging: https://$S3_BUCKET_STAGING/
      üåê Production: https://$S3_BUCKET_PRODUCTION/
      
      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      EOF
    
    # Add your notification webhook here (Slack, Discord, Email, etc.)
    # Example Slack webhook:
    # - |
    #   curl -X POST $SLACK_WEBHOOK_URL \
    #     -H 'Content-Type: application/json' \
    #     -d "{\"text\":\"Deployment completed for $APP_NAME\"}"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
  allow_failure: true
